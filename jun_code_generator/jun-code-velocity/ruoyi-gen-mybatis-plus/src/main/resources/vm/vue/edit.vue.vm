<template>
    <div class="app-edit">
        <el-form ref="form" :model="form" :rules="rules" label-width="150px">
            #foreach($column in $columns)
                #set($field=$column.javaField)
                #if($column.insert && !$column.pk)
                    #if(($column.usableColumn) || (!$column.superColumn))
                        #set($parentheseIndex=$column.columnComment.indexOf("（"))
                        #if($parentheseIndex != -1)
                            #set($comment=$column.columnComment.substring(0, $parentheseIndex))
                        #else
                            #set($comment=$column.columnComment)
                        #end
                        #set($dictType=$column.dictType)
                        #if($column.htmlType == "input")
                            <el-form-item label="${comment}" prop="${field}">
                                <el-input v-model="form.${field}" placeholder="请输入${comment}" />
                            </el-form-item>
                        #elseif($column.htmlType == "imageUpload")
                            <el-form-item label="${comment}">
                                <image-upload v-model="form.${field}"/>
                            </el-form-item>
                        #elseif($column.htmlType == "fileUpload")
                            <el-form-item label="${comment}">
                                <file-upload v-model="form.${field}"/>
                            </el-form-item>
                        #elseif($column.htmlType == "editor")
                            <el-form-item label="${comment}">
                                <editor v-model="form.${field}" :min-height="192"/>
                            </el-form-item>
                        #elseif($column.htmlType == "select" && "" != $dictType)
                            <el-form-item label="${comment}" prop="${field}">
                                <el-select v-model="form.${field}" placeholder="请选择${comment}">
                                    <el-option
                                            v-for="dict in dict.type.${dictType}"
                                            :key="dict.value"
                                            :label="dict.label"
                                            #if($column.javaType == "Integer" || $column.javaType == "Long")
                                            :value="parseInt(dict.value)"
                                            #else
                                            :value="dict.value"
                                            #end

                                    ></el-option>
                                </el-select>
                            </el-form-item>
                        #elseif($column.htmlType == "select" && $dictType)
                            <el-form-item label="${comment}" prop="${field}">
                                <el-select v-model="form.${field}" placeholder="请选择${comment}">
                                    <el-option label="请选择字典生成" value="" />
                                </el-select>
                            </el-form-item>
                        #elseif($column.htmlType == "checkbox" && "" != $dictType)
                            <el-form-item label="${comment}">
                                <el-checkbox-group v-model="form.${field}">
                                    <el-checkbox
                                            v-for="dict in dict.type.${dictType}"
                                            :key="dict.value"
                                            :label="dict.value">
                                        {{dict.label}}
                                    </el-checkbox>
                                </el-checkbox-group>
                            </el-form-item>
                        #elseif($column.htmlType == "checkbox" && $dictType)
                            <el-form-item label="${comment}">
                                <el-checkbox-group v-model="form.${field}">
                                    <el-checkbox>请选择字典生成</el-checkbox>
                                </el-checkbox-group>
                            </el-form-item>
                        #elseif($column.htmlType == "radio" && "" != $dictType)
                            <el-form-item label="${comment}">
                                <el-radio-group v-model="form.${field}">
                                    <el-radio
                                            v-for="dict in dict.type.${dictType}"
                                            :key="dict.value"
                                            #if($column.javaType == "Integer" || $column.javaType == "Long"):label="parseInt(dict.value)"#else:label="dict.value"#end

                                    >{{dict.label}}</el-radio>
                                </el-radio-group>
                            </el-form-item>
                        #elseif($column.htmlType == "radio" && $dictType)
                            <el-form-item label="${comment}">
                                <el-radio-group v-model="form.${field}">
                                    <el-radio label="1">请选择字典生成</el-radio>
                                </el-radio-group>
                            </el-form-item>
                        #elseif($column.htmlType == "datetime")
                            <el-form-item label="${comment}" prop="${field}">
                                <el-date-picker clearable size="small"
                                                v-model="form.${field}"
                                                type="date"
                                                value-format="yyyy-MM-dd"
                                                placeholder="选择${comment}">
                                </el-date-picker>
                            </el-form-item>
                        #elseif($column.htmlType == "textarea")
                            <el-form-item label="${comment}" prop="${field}">
                                <el-input v-model="form.${field}" type="textarea" placeholder="请输入内容" />
                            </el-form-item>
                        #end
                    #end
                #end
            #end
            #if($table.sub)
                <el-divider content-position="center">${subTable.functionName}信息</el-divider>
                <el-row :gutter="10" class="mb8">
                    <el-col :span="1.5">
                        <el-button type="primary" icon="el-icon-plus" size="mini" @click="handleAdd${subClassName}">添加</el-button>
                    </el-col>
                    <el-col :span="1.5">
                        <el-button type="danger" icon="el-icon-delete" size="mini" @click="handleDelete${subClassName}">删除</el-button>
                    </el-col>
                </el-row>
                <el-table :data="${subclassName}List" :row-class-name="row${subClassName}Index" @selection-change="handle${subClassName}SelectionChange" ref="${subclassName}">
                    <el-table-column type="selection" width="50" align="center" />
                    <el-table-column label="序号" align="center" prop="index" width="50"/>
                    #foreach($column in $subTable.columns)
                        #set($javaField=$column.javaField)
                        #set($parentheseIndex=$column.columnComment.indexOf("（"))
                        #if($parentheseIndex != -1)
                            #set($comment=$column.columnComment.substring(0, $parentheseIndex))
                        #else
                            #set($comment=$column.columnComment)
                        #end
                        #if($column.pk || $javaField == ${subTableFkclassName})
                        #elseif($column.list && "" != $javaField)
                            <el-table-column label="$comment" prop="${javaField}">
                                <template slot-scope="scope">
                                    <el-input v-model="scope.row.$javaField" placeholder="请输入$comment" />
                                </template>
                            </el-table-column>
                        #end
                    #end
                </el-table>
            #end
        </el-form>
        <div slot="footer" class="dialog-footer" style="text-align:center;">
            <el-button type="primary" @click="submitForm">确 定</el-button>
            <el-button @click="cancel">取 消</el-button>
        </div>
    </div>
</template>

<script>
    import { list${ClassName}, get${ClassName}, del${ClassName}, add${ClassName}, update${ClassName} } from "@/api/${moduleName}/${className}";

    export default {
        name: "${ClassName}Ele",
        #if(${dicts} != '')
            dicts: [${dicts}],
        #end
        props:{
            id:{
                type:String,
                default:undefined
            },
            // 弹出层标题
            title:{
                type:String,
                default:undefined
            },
            // 是否显示弹出层
            open: {
                type: Boolean,
                default: false,
            },
        },
        data() {
            return {
                // 遮罩层
                loading: true,
                // 选中数组
                ids: [],
                #if($table.sub)
                    // 子表选中数据
                    checked${subClassName}: [],
                #end
                // 非单个禁用
                single: true,
                // 非多个禁用
                multiple: true,
                // 显示搜索条件
                showSearch: true,
                // 总条数
                total: 0,
                // ${functionName}表格数据
                    ${className}List: [],
                #if($table.sub)
                    // ${subTable.functionName}表格数据
                        ${subclassName}List: [],
                #end

                #foreach ($column in $columns)
                    #if($column.htmlType == "datetime" && $column.queryType == "BETWEEN")
                        #set($AttrName=$column.javaField.substring(0,1).toUpperCase() + ${column.javaField.substring(1)})
                        // $comment时间范围
                        daterange${AttrName}: [],
                    #end
                #end
                // 查询参数
                queryParams: {
                    pageNum: 1,
                    pageSize: 10,
            #foreach ($column in $columns)
                #if($column.query)
                    $column.javaField: null#if($foreach.count != $columns.size()),#end
                #end
            #end
        },
            // 表单参数
            form: {},
            // 表单校验
            rules: {
                #foreach ($column in $columns)
                    #if($column.required)
                        #set($parentheseIndex=$column.columnComment.indexOf("（"))
                        #if($parentheseIndex != -1)
                            #set($comment=$column.columnComment.substring(0, $parentheseIndex))
                        #else
                            #set($comment=$column.columnComment)
                        #end
                        $column.javaField: [
                        { required: true, message: "$comment不能为空", trigger: #if($column.htmlType == "select")"change"#else"blur"#end }
                    ]#if($foreach.count != $columns.size()),#end
                    #end
                #end
            }
        };
        },
        created() {},
        watch: {
            open: {
                handler(val) {
                    if (val) {
                        if(this.id){
                            this.handleInit();
                        }
                    } else {
                        this.reset();
                    }
                },
                immediate: true,
                deep: true,
            },
        },
        methods: {
            /** 查询${functionName}列表 */
            // 取消按钮
            cancel() {
                this.#[[$]]#emit("cancel")
            },
            // 表单重置
            reset() {
                this.form = {
                #foreach ($column in $columns)
                    #if($column.htmlType == "radio")
                        $column.javaField: #if($column.javaType == "Integer" || $column.javaType == "Long")0#else"0"#end#if($foreach.count != $columns.size()),#end
                    #elseif($column.htmlType == "checkbox")
                        $column.javaField: []#if($foreach.count != $columns.size()),#end
                    #else
                        $column.javaField: null#if($foreach.count != $columns.size()),#end
                    #end
                #end
            };
                #if($table.sub)
                    this.${subclassName}List = [];
                #end
                this.resetForm("form");
            },
            /** 搜索按钮操作 */
            handleQuery() {
                this.queryParams.pageNum = 1;
                this.getList();
            },
            // 多选框选中数据
            handleSelectionChange(selection) {
                this.ids = selection.map(item => item.${pkColumn.javaField})
                this.single = selection.length!==1
                this.multiple = !selection.length
            },
            /** 修改按钮操作 */
            handleInit() {
                get${ClassName}(this.id).then(response => {
                    this.form = response.data;
                    #foreach ($column in $columns)
                        #if($column.htmlType == "checkbox")
                            this.form.$column.javaField = this.form.${column.javaField}.split(",");
                        #end
                    #end
                    #if($table.sub)
                        this.${subclassName}List = response.data.${subclassName}List;
                    #end
                    this.open = true;
                    // this.title = "修改${functionName}";
                });
            },
            /** 提交按钮 */
            submitForm() {
                this.#[[$]]#refs["form"].validate(valid => {
                    if (valid) {
                        #foreach ($column in $columns)
                        #if($column.htmlType == "checkbox")
                        this.form.$column.javaField = this.form.${column.javaField}.join(",");
                        #end
                        #end
                        #if($table.sub)
                        this.form.${subclassName}List = this.${subclassName}List;
                        #end
                        if (this.form.${pkColumn.javaField} != null) {
                            update${ClassName}(this.form).then(response => {
                                this.#[[$modal]]#.msgSuccess("修改成功");
                                this.#[[$]]#emit("submit")
                            });
                        } else {
                            add${ClassName}(this.form).then(response => {
                                this.#[[$modal]]#.msgSuccess("新增成功");
                                this.#[[$]]#emit("submit")
                            });
                        }
                    }
                });
            },
            /** 删除按钮操作 */
            handleDelete(row) {
                const ${pkColumn.javaField}s = row.${pkColumn.javaField} || this.ids;
                this.#[[$modal]]#.confirm('是否确认删除${functionName}编号为"' + ${pkColumn.javaField}s + '"的数据项？').then(function() {
                    return del${ClassName}(${pkColumn.javaField}s);
                }).then(() => {
                    this.getList();
                    this.#[[$modal]]#.msgSuccess("删除成功");
                }).catch(() => {});
            },

    }
    };
</script>
<style lang="scss" scoped>
</style>