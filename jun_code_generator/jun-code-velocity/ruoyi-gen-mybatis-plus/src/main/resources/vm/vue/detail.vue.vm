<template>
    <div class="app-edit">
        <el-form ref="form" :model="form" :rules="rules" label-width="150px">
            <el-row :gutter="gutter">
                #foreach($column in $columns)
                    #set($field=$column.javaField)
                    #if($column.insert && !$column.pk)
                        #if(($column.usableColumn) || (!$column.superColumn))
                            #set($parentheseIndex=$column.columnComment.indexOf("（"))
                            #if($parentheseIndex != -1)
                                #set($comment=$column.columnComment.substring(0, $parentheseIndex))
                            #else
                                #set($comment=$column.columnComment)
                            #end
                            #set($dictType=$column.dictType)
                            <el-col :span="span">
                                <el-form-item label="${comment}" prop="${field}">
                                    #if("" != $column.dictType)
                                        <dict-tag :options="dict.type.${column.dictType}" :value="form.${field}"/>
                                    #else
                                        <div>{{ form.${field} }}</div>
                                    #end
                                </el-form-item>
                            </el-col>
                        #end
                    #end
                #end
            </el-row>

            #if($table.sub)
                <el-divider content-position="center">${subTable.functionName}信息</el-divider>
                <el-row :gutter="10" class="mb8">
                    <el-col :span="1.5">
                        <el-button type="primary" icon="el-icon-plus" size="mini" @click="handleAdd${subClassName}">添加
                        </el-button>
                    </el-col>
                    <el-col :span="1.5">
                        <el-button type="danger" icon="el-icon-delete" size="mini" @click="handleDelete${subClassName}">
                            删除
                        </el-button>
                    </el-col>
                </el-row>
                <el-table :data="${subclassName}List" :row-class-name="row${subClassName}Index"
                          @selection-change="handle${subClassName}SelectionChange" ref="${subclassName}">
                    <el-table-column type="selection" width="50" align="center"/>
                    <el-table-column label="序号" align="center" prop="index" width="50"/>
                    #foreach($column in $subTable.columns)
                        #set($javaField=$column.javaField)
                        #set($parentheseIndex=$column.columnComment.indexOf("（"))
                        #if($parentheseIndex != -1)
                            #set($comment=$column.columnComment.substring(0, $parentheseIndex))
                        #else
                            #set($comment=$column.columnComment)
                        #end
                        #if($column.pk || $javaField == ${subTableFkclassName})
                        #elseif($column.list && "" != $javaField)
                            <el-table-column label="$comment" prop="${javaField}">
                                <template slot-scope="scope">
                                    <el-input v-model="scope.row.$javaField" placeholder="请输入$comment"/>
                                </template>
                            </el-table-column>
                        #end
                    #end
                </el-table>
            #end
        </el-form>
        <div slot="footer" class="dialog-footer" style="text-align:center;">
            <el-button type="primary" @click="cancel">确 定</el-button>
        </div>
    </div>
</template>

<script>
    import {
        list${ClassName},
        get${ClassName},
        del${ClassName},
        add${ClassName},
        update${ClassName} } from "@/api/${moduleName}/${className}";

    export default {
        name: "${ClassName}Ele",
        #if(${dicts} != '')
            dicts: [${dicts}],
        #end
        props: {
            id: {
                type: String,
                default: ""
            },
            // 弹出层标题
            title:{
                type:String,
                default:undefined
            },
            // 是否显示弹出层
            open: {
                type: Boolean,
                default: false,
            },
        },
        data() {
            return {
                gutter: 120,
                span: 15,
                // 遮罩层
                loading: true,
                // 选中数组
                ids: [],
                #if($table.sub)
                    // 子表选中数据
                    checked${subClassName}: [],
                #end
                // 非单个禁用
                single: true,
                // 非多个禁用
                multiple: true,
                // 显示搜索条件
                showSearch: true,
                // 总条数
                total: 0,
                // ${functionName}表格数据
                    ${className}List: [],
                #if($table.sub)
                    // ${subTable.functionName}表格数据
                        ${subclassName}List: [],
                #end
                #foreach ($column in $columns)
                    #if($column.htmlType == "datetime" && $column.queryType == "BETWEEN")
                        #set($AttrName=$column.javaField.substring(0,1).toUpperCase() + ${column.javaField.substring(1)})
                        // $comment时间范围
                        daterange${AttrName}: [],
                    #end
                #end
                // 查询参数
                queryParams: {
                    pageNum: 1,
                    pageSize: 10,
            #foreach ($column in $columns)
                #if($column.query)
                    $column.javaField: null#if($foreach.count != $columns.size()),#end
                #end
            #end
        },
            // 表单参数
            form: {},
            // 表单校验
            rules: {
                #foreach ($column in $columns)
                    #if($column.required)
                        #set($parentheseIndex=$column.columnComment.indexOf("（"))
                        #if($parentheseIndex != -1)
                            #set($comment=$column.columnComment.substring(0, $parentheseIndex))
                        #else
                            #set($comment=$column.columnComment)
                        #end
                        $column.javaField: [
                        { required: true, message: "$comment不能为空", trigger: #if($column.htmlType == "select")"change"#else"blur"#end }
                    ]#if($foreach.count != $columns.size()),#end
                    #end
                #end
            }
        };
        },
        created() {},
        watch: {
            open: {
                handler(val) {
                    if (val) {
                        if(this.id){
                            this.handleInit();
                        }
                    } else {
                        this.reset();
                    }
                },
                immediate: true,
                deep: true,
            },
        },
        methods: {
            /** 查询${functionName}列表 */
            // 取消按钮
            cancel() {
                this.#[[$]]#emit("cancel")
            },
            // 表单重置
            reset() {
                this.form = {
                #foreach ($column in $columns)
                #if($column.htmlType == "radio")
                $column.javaField: #if($column.javaType == "Integer" || $column.javaType == "Long")0#else"0"#end#if($foreach.count != $columns.size()),#end
                #elseif($column.htmlType == "checkbox")
                $column.javaField: []#if($foreach.count != $columns.size()),#end
                #else
                $column.javaField: null#if($foreach.count != $columns.size()),#end
                #end
                #end
            };
                #if($table.sub)
                this.${subclassName}List = [];
                #end
                this.resetForm("form");
            },
            /** 搜索按钮操作 */
            handleQuery() {
                this.queryParams.pageNum = 1;
                this.getList();
            },
            // 多选框选中数据
            handleSelectionChange(selection) {
                this.ids = selection.map(item => item.${pkColumn.javaField})
                this.single = selection.length!==1
                this.multiple = !selection.length
            },
            /** 修改按钮操作 */
            handleInit() {
                get${ClassName}(this.id).then(response => {
                    this.form = response.data;
                    #foreach ($column in $columns)
                    #if($column.htmlType == "checkbox")
                    this.form.$column.javaField = this.form.${column.javaField}.split(",");
                    #end
                    #end
                    #if($table.sub)
                    this.${subclassName}List = response.data.${subclassName}List;
                    #end
                    this.open = true;
                    // this.title = "修改${functionName}";
                });
            },
            /** 删除按钮操作 */
            handleDelete(row) {
                const ${pkColumn.javaField}s = row.${pkColumn.javaField} || this.ids;
                this.#[[$modal]]#.confirm('是否确认删除${functionName}编号为"' + ${pkColumn.javaField}s + '"的数据项？').then(function() {
                    return del${ClassName}(${pkColumn.javaField}s);
                }).then(() => {
                    this.getList();
                    this.#[[$modal]]#.msgSuccess("删除成功");
                }).catch(() => {});
            },

        }
    };
</script>
<style lang="scss" scoped>
</style>